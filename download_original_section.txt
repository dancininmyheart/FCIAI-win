@main.route('/download_translated_pdf/<filename>')
@login_required
def download_translated_pdf(filename):
    """涓嬭浇缈昏瘧鍚庣殑PDF鏂囦欢锛堝疄闄呬笂鏄疻ord鏂囨。锛?""
    try:
        logger.info(f"鐢ㄦ埛 {current_user.username} 璇锋眰涓嬭浇鏂囦欢: {filename}")
        
        # 纭繚鏂囦欢鍚嶆槸瀹夊叏鐨?        from werkzeug.utils import secure_filename
        filename = secure_filename(filename)
        logger.info(f"瀹夊叏鏂囦欢鍚? {filename}")
        
        # 鏋勫缓鏂囦欢璺緞 - 浣跨敤椤圭洰鏍圭洰褰曚笅鐨剈ploads鏂囦欢澶?        project_root = (os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
        upload_folder = current_app.config['UPLOAD_FOLDER']
        
        # 纭繚浣跨敤姝ｇ‘鐨勪笂浼犳枃浠跺す璺緞
        # UPLOAD_FOLDER閰嶇疆鏄浉瀵逛簬椤圭洰鏍圭洰褰曠殑
        if not os.path.isabs(upload_folder):
            upload_folder = os.path.join(project_root, upload_folder)
        
        pdf_output_dir = os.path.join(upload_folder, 'pdf_outputs')
        file_path = os.path.join(pdf_output_dir, filename)
        
        logger.info(f"椤圭洰鏍圭洰褰? {project_root}")
        logger.info(f"涓婁紶鏂囦欢澶归厤缃? {current_app.config['UPLOAD_FOLDER']}")
        logger.info(f"瀹為檯涓婁紶鏂囦欢澶硅矾寰? {upload_folder}")
        logger.info(f"PDF杈撳嚭鐩綍: {pdf_output_dir}")
        logger.info(f"鏈熸湜鐨勬枃浠惰矾寰? {file_path}")
        logger.info(f"鏂囦欢缁濆璺緞: {os.path.abspath(file_path)}")
        
        # 妫€鏌ョ洰褰曟槸鍚﹀瓨鍦?        if not os.path.exists(pdf_output_dir):
            logger.error(f"PDF杈撳嚭鐩綍涓嶅瓨鍦? {pdf_output_dir}")
            os.makedirs(pdf_output_dir, exist_ok=True)
            logger.info(f"宸插垱寤篜DF杈撳嚭鐩綍: {pdf_output_dir}")
        
        # 妫€鏌ユ枃浠舵槸鍚﹀瓨鍦?        if not os.path.exists(file_path):
            logger.error(f"涓嬭浇鏂囦欢涓嶅瓨鍦? {file_path}")
            logger.error(f"鏂囦欢缁濆璺緞: {os.path.abspath(file_path)}")
            
            # 鍒楀嚭杈撳嚭鐩綍涓殑鎵€鏈夋枃浠?            if os.path.exists(pdf_output_dir):
                files_in_dir = os.listdir(pdf_output_dir)
                logger.info(f"鐩綍涓殑鏂囦欢鍒楄〃: {files_in_dir}")
                
                # 灏濊瘯绮剧‘鍖归厤鏂囦欢鍚嶏紙涓嶅甫璺緞锛?                matched_files = [f for f in files_in_dir if f == filename]
                logger.info(f"绮剧‘鍖归厤鐨勬枃浠? {matched_files}")
                
                if matched_files:
                    # 浣跨敤绗竴涓尮閰嶇殑鏂囦欢
                    file_path = os.path.join(pdf_output_dir, matched_files[0])
                    filename = matched_files[0]
                    logger.info(f"浣跨敤绮剧‘鍖归厤鐨勬枃浠? {file_path}")
                    logger.info(f"绮剧‘鍖归厤鏂囦欢鐨勭粷瀵硅矾寰? {os.path.abspath(file_path)}")
                else:
                    # 灏濊瘯妯＄硦鍖归厤鏂囦欢鍚?                    matched_files = [f for f in files_in_dir if filename in f or f.startswith(filename.split('.')[0])]
                    logger.info(f"妯＄硦鍖归厤鐨勬枃浠? {matched_files}")
                    
                    if matched_files:
                        # 浣跨敤绗竴涓尮閰嶇殑鏂囦欢
                        file_path = os.path.join(pdf_output_dir, matched_files[0])
                        filename = matched_files[0]
                        logger.info(f"浣跨敤妯＄硦鍖归厤鐨勬枃浠? {file_path}")
                        logger.info(f"妯＄硦鍖归厤鏂囦欢鐨勭粷瀵硅矾寰? {os.path.abspath(file_path)}")
                    else:
                        # 濡傛灉娌℃湁鍖归厤鐨勬枃浠讹紝灏濊瘯鏌ユ壘浠讳綍docx鏂囦欢
                        docx_files = [f for f in files_in_dir if f.endswith('.docx')]
                        if docx_files:
                            file_path = os.path.join(pdf_output_dir, docx_files[0])
                            filename = docx_files[0]
                            logger.info(f"浣跨敤鐩綍涓殑绗竴涓猟ocx鏂囦欢: {file_path}")
                            logger.info(f"绗竴涓猟ocx鏂囦欢鐨勭粷瀵硅矾寰? {os.path.abspath(file_path)}")
            else:
                logger.error("PDF杈撳嚭鐩綍涓嶅瓨鍦?)
                return jsonify({'success': False, 'error': '鏂囦欢鐩綍涓嶅瓨鍦?}), 404
        
        # 鍐嶆妫€鏌ユ枃浠舵槸鍚﹀瓨鍦?        if not os.path.exists(file_path):
            logger.error(f"鏂囦欢浠嶇劧涓嶅瓨鍦? {file_path}")
            logger.error(f"鏂囦欢缁濆璺緞: {os.path.abspath(file_path)}")
            # 鍒楀嚭鎵€鏈夊彲鑳界殑鏂囦欢
            if os.path.exists(pdf_output_dir):
                all_files = os.listdir(pdf_output_dir)
                logger.info(f"杈撳嚭鐩綍涓墍鏈夋枃浠? {all_files}")
            return jsonify({'success': False, 'error': '鏂囦欢涓嶅瓨鍦?}), 404
        
        # 纭繚鏂囦欢鎵╁睍鍚嶆纭?        if not filename.endswith('.docx'):
            logger.warning(f"涓嬭浇鏂囦欢鎵╁睍鍚嶄笉姝ｇ‘: {filename}")
            # 淇鏂囦欢鎵╁睍鍚?            if not filename.endswith('.docx') and os.path.exists(file_path):
                filename += '.docx'
        
        logger.info(f"鍙戦€佹枃浠剁粰鐢ㄦ埛: {file_path}")
        logger.info(f"鏂囦欢澶у皬: {os.path.getsize(file_path)} 瀛楄妭")
        logger.info(f"鏂囦欢缁濆璺緞: {os.path.abspath(file_path)}")
        
        # 纭繚浣跨敤缁濆璺緞鍙戦€佹枃浠?        absolute_file_path = os.path.abspath(file_path)
        if os.path.exists(absolute_file_path):
            logger.info(f"浣跨敤缁濆璺緞鍙戦€佹枃浠? {absolute_file_path}")
            return send_file(absolute_file_path, as_attachment=True, download_name=filename)
        else:
            logger.error(f"缁濆璺緞鏂囦欢涔熶笉瀛樺湪: {absolute_file_path}")
            return jsonify({'success': False, 'error': '鏂囦欢涓嶅瓨鍦?}), 404
            
    except Exception as e:
        logger.error(f"涓嬭浇鏂囦欢鏃跺嚭閿? {e}")
        import traceback
        logger.error(f"閿欒璇︽儏: {traceback.format_exc()}")
        return jsonify({'success': False, 'error': f'涓嬭浇鏂囦欢鏃跺嚭閿? {str(e)}'}), 500


